# OCT 算法优化技术方案

**目标**: 消除由信噪比（SNR）截断导致的“深层分辨率假优”伪影，确保报告的半高宽（FWHM）数值反映系统的真实光学性能。

## 1. 核心概念：基于信噪比的置信度加权 (SNR-Weighted Confidence)

当前系统对所有检测到的“微球”一视同仁。然而在现实中，深层低信噪比的微球由于噪声截断效应，会产生人为变小的 FWHM 数值（假象）。

* **实验验证**: 用户数据表明，深层 ROI 的 FWHM 比浅层 ROI 更小（更好），这与物理学规律（散焦导致变差）相悖。
* **解决方案**: 优先信赖高信噪比（通常位于浅层）的数据。

## 2. 实施策略

### 策略 A: 严格的 SNR 筛选与加权

不再使用单一的 `Pass/Fail` 阈值（如当前 SNR=8.0），而是实施更严格的分级筛选：

1. **计算局部 SNR** (现有功能):

$$ SNR = \frac{Peak - Background_{mean}}{Background_{std}} $$
2. **严格的高置信度筛选**:
    *设定一个极高的“计量级”阈值，例如 **SNR > 20.0 (26dB)**。
    * 只有通过此“黄金阈值”的微球，才允许参与最终“名义分辨率”的计算。
3. **低 SNR 剔除**:
    * 显式拒绝那些 SNR 较低且 FWHM 异常小的微球。例如：若 `SNR < 15.0` 且 `FWHM < 0.5 * 预期值`，则判定为“噪声截断伪影”并剔除。

### 策略 B: 高置信度区域 (HCR) 自动选择

不再对全图进行平均，算法将自动搜寻“最佳测量区域”。

1. **深度分层 (Binning)**:
    * 将 Z 轴按固定步长（如 50μm）划分为若干区间。
2. **区间统计**:
    * 计算每个区间的 **中位 SNR** 和 **中位 FWHM**。
3. **区域选择器**:
    * 识别 **中位 SNR 最高** 的区间。
    * 仅报告 **该区间** 的分辨率作为系统的“测量能力”。
    * *原理*: SNR 最高的区域受噪声截断影响最小，因此提供的 PSF 测量结果最诚实、最可信。

### 策略 C: 深度归一化强度 (Roll-off 补偿)

对图像进行预处理，以平坦化相对底噪，或基于深度对信号进行归一化。

* *实现*: 拟合 A-scan 峰值的指数衰减曲线：

$$ I(z) = I_0 e^{-\alpha z} $$

* *归一化*: 在检测前，将深层像素值乘以补偿系数 $e^{\alpha z}$。
* *收益*: 使“相对强度筛选”在所有深度上更加公平（目前该滤波器倾向于过度剔除深层信号，虽有助于排除伪影，但不够可控）。

## 3. 建议执行步骤

1. **修改 `AnalysisResult` 模型**: 增加 `high_confidence_fwhm`（高置信度分辨率）和 `hcr_depth_range`（高置信度深度范围）字段。
2. **更新 `run_analysis` 流程**:
    * 首先计算 SNR 直方图分布。
    * 根据 SNR 分布确定 `HCR` (高置信度区域)。
    * 仅在 HCR 子集上计算统计指标。
3. **更新筛选逻辑**:
    * 增加 `min_metrology_snr` 参数（默认建议 20.0）。
    * 增加逻辑以标记并剔除“低 SNR 截断伪影”。

## 4. 评估指标

* **成功标准**: 优化后，对“深层 ROI”进行分析时，系统应返回 **“结果无效”**（因 SNR 过低被拒绝）或 **更大的 FWHM**（如果 SNR 足以分辨模糊边界）。绝不应再出现深层分辨率数值“优于”浅层的反物理现象。
